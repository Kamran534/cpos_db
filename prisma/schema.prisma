// schema.prisma - Central PostgreSQL Database
generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL_REMOTE")
}

// ============================================
// STORE & BRANCH MANAGEMENT
// ============================================

model Store {
  id        String  @id @default(uuid())
  storeCode String  @unique
  storeName String
  legalName String?
  taxId     String?

  // Contact & Address
  email        String?
  phone        String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zipCode      String?
  country      String  @default("US")

  // Configuration
  timezone        String  @default("UTC")
  defaultCurrency String  @default("USD")
  defaultLanguage String  @default("en")
  isActive        Boolean @default(true)

  // Subscription
  subscriptionTier   String    @default("STANDARD")
  subscriptionExpiry DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  branches       Branch[]
  users          User[]
  terminals      Terminal[]
  products       Product[]
  categories     Category[]
  brands         Brand[]
  customers      Customer[]
  customerGroups CustomerGroup[]
  taxCategories  TaxCategory[]
  saleOrders     SaleOrder[]
  storeSettings  StoreSettings?
  auditLogs      AuditLog[]

  @@map("stores")
}

model Branch {
  id      String @id @default(uuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  branchCode String @unique
  branchName String

  // Contact Information
  email     String?
  phone     String?
  managerId String? // Reference to User

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zipCode      String?
  country      String  @default("US")

  // Configuration
  timezone      String  @default("UTC")
  currency      String  @default("USD")
  taxRate       Float   @default(0)
  businessHours String? // JSON string for business hours

  // Sync Configuration
  syncEnabled  Boolean @default(true)
  syncInterval Int     @default(300) // seconds

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  locations Location[]
  terminals Terminal[]
  syncLogs  SyncLog[]
  conflicts SyncConflict[]

  @@index([storeId])
  @@index([branchCode])
  @@map("branches")
}

// ============================================
// TERMINAL MANAGEMENT & REGISTRATION
// ============================================

model Terminal {
  id       String @id @default(uuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  storeId  String
  store    Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Terminal Identification
  terminalCode String  @unique
  terminalName String
  macAddress   String  @unique
  serialNumber String? @unique

  // Authentication & Security
  apiKey    String  @unique
  secretKey String?
  isActive  Boolean @default(false) // Activated by admin

  // Location
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  // Configuration
  allowedIPs String[]
  features   String[]
  version    String?

  // Status & Connectivity
  status        TerminalStatus @default(INACTIVE)
  lastHeartbeat DateTime?
  lastSyncAt    DateTime?
  ipAddress     String?

  // Registration
  registeredBy    String // Admin user ID
  registeredAt    DateTime  @default(now())
  lastActivatedAt DateTime?

  // Relationships
  syncStates         TerminalSyncState[]
  syncLogs           SyncLog[]
  conflicts          SyncConflict[]
  saleOrders         SaleOrder[]
  shifts             Shift[]
  auditLogs          AuditLog[]
  terminalActivation TerminalActivation?
  stockAdjustments   StockAdjustment[]

  @@index([branchId])
  @@index([storeId])
  @@index([terminalCode])
  @@index([macAddress])
  @@index([status])
  @@map("terminals")
}

model TerminalActivation {
  id         String   @id @default(uuid())
  terminalId String   @unique
  terminal   Terminal @relation(fields: [terminalId], references: [id], onDelete: Cascade)

  activationCode String    @unique
  expiresAt      DateTime
  activatedAt    DateTime?
  activatedBy    String? // Terminal user who activated

  createdAt DateTime @default(now())

  @@index([activationCode])
  @@map("terminal_activations")
}

enum TerminalStatus {
  INACTIVE
  ONLINE
  OFFLINE
  SYNCING
  MAINTENANCE
  ERROR
  DISABLED
}

// ============================================
// SYNC MANAGEMENT & MONITORING
// ============================================

model TerminalSyncState {
  id         String   @id @default(uuid())
  terminalId String   @unique
  terminal   Terminal @relation(fields: [terminalId], references: [id], onDelete: Cascade)

  // Sync Status
  syncStatus      SyncStatus @default(OFFLINE)
  lastSyncAt      DateTime?
  lastSuccessSync DateTime?

  // Sync Cursors
  lastProductSync   DateTime?
  lastCustomerSync  DateTime?
  lastOrderSync     DateTime?
  lastInventorySync DateTime?
  lastPaymentSync   DateTime?

  // Statistics
  pendingChanges   Int @default(0)
  syncSuccessCount Int @default(0)
  syncErrorCount   Int @default(0)

  // Configuration
  autoSync     Boolean @default(true)
  syncInterval Int     @default(300)

  updatedAt DateTime @updatedAt

  @@index([terminalId])
  @@map("terminal_sync_states")
}

model SyncLog {
  id         String   @id @default(uuid())
  terminalId String
  terminal   Terminal @relation(fields: [terminalId], references: [id], onDelete: Cascade)
  branchId   String
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  syncType    SyncType
  direction   SyncDirection
  startedAt   DateTime      @default(now())
  completedAt DateTime?

  // Statistics
  entitiesProcessed Int @default(0)
  entitiesCreated   Int @default(0)
  entitiesUpdated   Int @default(0)
  entitiesDeleted   Int @default(0)
  conflictsFound    Int @default(0)

  // Status
  success      Boolean @default(false)
  errorMessage String?
  durationMs   Int?

  @@index([terminalId])
  @@index([branchId])
  @@index([startedAt])
  @@map("sync_logs")
}

model SyncConflict {
  id         String   @id @default(uuid())
  terminalId String
  terminal   Terminal @relation(fields: [terminalId], references: [id], onDelete: Cascade)
  branchId   String
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  entityType   String
  entityId     String
  conflictType ConflictType
  detectedAt   DateTime     @default(now())

  // Data Versions
  terminalData Json
  centralData  Json
  resolvedData Json?

  // Resolution
  resolution     ConflictResolution @default(PENDING)
  resolvedBy     String?
  resolvedAt     DateTime?
  resolutionNote String?

  @@index([terminalId])
  @@index([entityType, entityId])
  @@index([resolution])
  @@map("sync_conflicts")
}

enum SyncType {
  FULL
  INCREMENTAL
  PUSH_ONLY
  PULL_ONLY
  CONFLICT_RESOLUTION
}

enum SyncDirection {
  UPLOAD
  DOWNLOAD
  BIDIRECTIONAL
}

enum SyncStatus {
  ONLINE
  OFFLINE
  SYNCING
  ERROR
}

enum ConflictType {
  CONCURRENT_UPDATE
  DELETED_UPDATE
  DUPLICATE_CREATE
  VERSION_MISMATCH
}

enum ConflictResolution {
  PENDING
  TERMINAL_WINS
  CENTRAL_WINS
  MANUAL_MERGE
  DISCARD
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id      String @id @default(uuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  username     String  @unique
  email        String  @unique
  passwordHash String
  firstName    String
  lastName     String
  phone        String?
  pinCode      String? // For quick POS login

  role        UserRole @default(CASHIER)
  permissions String[]

  // Status
  isActive            Boolean   @default(true)
  lastLoginAt         DateTime?
  lastLoginTerminalId String?

  // Security
  loginAttempts      Int       @default(0)
  lockedUntil        DateTime?
  mustChangePassword Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  shifts    Shift[]
  auditLogs AuditLog[]

  @@index([storeId])
  @@index([email])
  @@index([role])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  STORE_MANAGER
  ASSISTANT_MANAGER
  CASHIER
  INVENTORY_MANAGER
  CUSTOMER_SERVICE
}

// ============================================
// LOCATION MANAGEMENT
// ============================================

model Location {
  id       String @id @default(uuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String       @unique
  name String
  type LocationType @default(STORE)

  // Address
  address String?
  city    String?
  state   String?
  zipCode String?
  country String  @default("US")

  // Contact
  phone String?
  email String?

  // Configuration
  timezone String @default("UTC")
  taxRate  Float  @default(0)

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sync Metadata
  lastSyncedAt DateTime?
  syncVersion  Int       @default(1)

  // Relationships
  terminals          Terminal[]
  saleOrders         SaleOrder[]
  inventoryItems     InventoryItem[]
  shifts             Shift[]
  stockAdjustments   StockAdjustment[]
  stockTransfersFrom StockTransfer[]   @relation("FromLocation")
  stockTransfersTo   StockTransfer[]   @relation("ToLocation")
  returnOrders       ReturnOrder[]
  serialNumbers      SerialNumber[]

  @@index([branchId])
  @@index([code])
  @@index([type])
  @@map("locations")
}

enum LocationType {
  STORE
  WAREHOUSE
  SHOWROOM
  KIOSK
}

// ============================================
// PRODUCT CATALOG
// ============================================

model Product {
  id      String @id @default(uuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  code        String      @unique
  name        String
  description String?
  type        ProductType @default(SIMPLE)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])
  brandId    String?
  brand      Brand?    @relation(fields: [brandId], references: [id])

  taxCategoryId String?
  taxCategory   TaxCategory? @relation(fields: [taxCategoryId], references: [id])

  imageUrl String?

  // Sync Metadata
  syncVersion   Int       @default(1)
  lastSyncedAt  DateTime?
  lastUpdatedBy String? // terminalId or userId
  isDirty       Boolean   @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  variants ProductVariant[]

  @@index([storeId])
  @@index([code])
  @@index([name])
  @@index([categoryId])
  @@index([isActive])
  @@map("products")
}

model ProductVariant {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  sku  String  @unique
  name String?

  // Pricing
  cost           Float  @default(0)
  price          Float
  compareAtPrice Float?

  // Inventory
  trackInventory Boolean @default(true)
  barcode        String? @unique
  upc            String?
  ean            String?

  // Variant Attributes
  color    String?
  size     String?
  material String?
  style    String?

  weight     Float?
  weightUnit String?

  // Sync Metadata
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  inventoryItems       InventoryItem[]
  saleOrderLines       SaleOrderLine[]
  returnOrderLines     ReturnOrderLine[]
  stockAdjustmentLines StockAdjustmentLine[]
  stockTransferLines   StockTransferLine[]
  serialNumbers        SerialNumber[]

  @@index([productId])
  @@index([sku])
  @@index([barcode])
  @@map("product_variants")
}

model Category {
  id      String @id @default(uuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  code        String  @unique
  name        String
  description String?
  imageUrl    String?

  parentId String?
  parent   Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children Category[] @relation("SubCategories")

  // Sync Metadata
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@index([storeId])
  @@index([code])
  @@index([parentId])
  @@map("categories")
}

model Brand {
  id      String @id @default(uuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  code        String  @unique
  name        String
  description String?
  logoUrl     String?

  // Sync Metadata
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@index([storeId])
  @@index([code])
  @@map("brands")
}

enum ProductType {
  SIMPLE
  VARIABLE
  COMBO
  DIGITAL
}

// ============================================
// CUSTOMER MANAGEMENT
// ============================================

model Customer {
  id      String @id @default(uuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  code      String  @unique
  firstName String
  lastName  String
  email     String? @unique
  phone     String? @unique

  dateOfBirth DateTime?
  gender      String?

  type    CustomerType   @default(REGULAR)
  groupId String?
  group   CustomerGroup? @relation(fields: [groupId], references: [id])

  // Loyalty & Spending
  loyaltyPoints Int   @default(0)
  totalSpent    Float @default(0)
  totalOrders   Int   @default(0)

  // Credit
  creditLimit    Float?
  currentBalance Float  @default(0)

  // Preferences
  allowMarketing Boolean @default(false)
  notes          String?

  // Sync Metadata
  syncVersion   Int       @default(1)
  lastSyncedAt  DateTime?
  lastUpdatedBy String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  addresses    CustomerAddress[]
  saleOrders   SaleOrder[]
  returnOrders ReturnOrder[]

  @@index([storeId])
  @@index([code])
  @@index([email])
  @@index([phone])
  @@index([type])
  @@map("customers")
}

model CustomerGroup {
  id      String @id @default(uuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  code            String  @unique
  name            String
  description     String?
  discountPercent Float   @default(0)

  // Sync Metadata
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customers Customer[]

  @@index([storeId])
  @@index([code])
  @@map("customer_groups")
}

model CustomerAddress {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  type         AddressType
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  zipCode      String
  country      String      @default("US")
  isDefault    Boolean     @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([type])
  @@map("customer_addresses")
}

enum CustomerType {
  REGULAR
  VIP
  WHOLESALE
  EMPLOYEE
  WHOLESALE_VIP
}

enum AddressType {
  BILLING
  SHIPPING
  BOTH
}

// ============================================
// INVENTORY MANAGEMENT
// ============================================

model InventoryItem {
  id         String         @id @default(uuid())
  variantId  String
  variant    ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  locationId String
  location   Location       @relation(fields: [locationId], references: [id])

  quantityOnHand    Int @default(0)
  quantityReserved  Int @default(0)
  quantityAvailable Int @default(0)

  reorderPoint    Int?
  reorderQuantity Int?

  lastCountedAt  DateTime?
  lastReceivedAt DateTime?

  // Sync Metadata - CRITICAL for inventory sync
  syncVersion   Int       @default(1)
  lastSyncedAt  DateTime?
  lastUpdatedBy String?
  pendingSync   Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([variantId, locationId])
  @@index([locationId])
  @@index([variantId])
  @@map("inventory_items")
}

model StockAdjustment {
  id         String   @id @default(uuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  adjustmentType  StockAdjustmentType
  reason          String?
  referenceNumber String?             @unique
  notes           String?

  adjustedBy String?
  adjustedAt DateTime @default(now())

  // Sync Metadata
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?
  terminalId   String?
  terminal     Terminal? @relation(fields: [terminalId], references: [id])

  lineItems StockAdjustmentLine[]

  createdAt DateTime @default(now())

  @@index([locationId])
  @@index([referenceNumber])
  @@map("stock_adjustments")
}

model StockAdjustmentLine {
  id           String          @id @default(uuid())
  adjustmentId String
  adjustment   StockAdjustment @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)
  variantId    String
  variant      ProductVariant  @relation(fields: [variantId], references: [id])

  quantityBefore Int
  quantityAfter  Int
  quantityChange Int

  @@index([adjustmentId])
  @@index([variantId])
  @@map("stock_adjustment_lines")
}

model StockTransfer {
  id             String   @id @default(uuid())
  fromLocationId String
  fromLocation   Location @relation("FromLocation", fields: [fromLocationId], references: [id])
  toLocationId   String
  toLocation     Location @relation("ToLocation", fields: [toLocationId], references: [id])

  transferNumber String         @unique
  status         TransferStatus @default(DRAFT)
  transferDate   DateTime       @default(now())
  notes          String?
  createdBy      String?

  // Sync Metadata
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?
  terminalId   String?

  lineItems StockTransferLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
  @@map("stock_transfers")
}

model StockTransferLine {
  id         String         @id @default(uuid())
  transferId String
  transfer   StockTransfer  @relation(fields: [transferId], references: [id], onDelete: Cascade)
  variantId  String
  variant    ProductVariant @relation(fields: [variantId], references: [id])
  quantity   Int
  received   Int?

  @@index([transferId])
  @@index([variantId])
  @@map("stock_transfer_lines")
}

model SerialNumber {
  id           String         @id @default(uuid())
  variantId    String
  variant      ProductVariant @relation(fields: [variantId], references: [id])
  serialNumber String         @unique
  status       SerialStatus   @default(IN_STOCK)

  orderId     String?
  order       SaleOrder?     @relation(fields: [orderId], references: [id])
  orderLineId String?
  orderLine   SaleOrderLine? @relation(fields: [orderLineId], references: [id])

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  receivedDate DateTime?
  soldDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([variantId])
  @@index([serialNumber])
  @@index([status])
  @@index([orderId])
  @@map("serial_numbers")
}

enum StockAdjustmentType {
  INCREASE
  DECREASE
  STOCK_TAKE
  DAMAGED
  EXPIRED
  FOUND
}

enum TransferStatus {
  DRAFT
  PENDING
  IN_TRANSIT
  RECEIVED
  CANCELLED
  PARTIALLY_RECEIVED
}

enum SerialStatus {
  IN_STOCK
  SOLD
  RETURNED
  DEFECTIVE
  RESERVED
  IN_TRANSIT
}

// ============================================
// SALES & TRANSACTIONS
// ============================================

model SaleOrder {
  id         String    @id @default(uuid())
  locationId String
  location   Location  @relation(fields: [locationId], references: [id])
  terminalId String?
  terminal   Terminal? @relation(fields: [terminalId], references: [id])
  storeId    String
  store      Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  orderNumber String      @unique
  type        OrderType   @default(SALE)
  status      OrderStatus @default(OPEN)
  source      OrderSource @default(POS)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])
  shiftId    String?
  shift      Shift?    @relation(fields: [shiftId], references: [id])

  userId String? // Cashier ID

  // Amounts
  subtotal       Float @default(0)
  taxAmount      Float @default(0)
  discountAmount Float @default(0)
  total          Float @default(0)

  // Timeline
  completedAt DateTime?
  voidedAt    DateTime?
  voidReason  String?

  // Receipt
  receiptPrinted   Boolean   @default(false)
  receiptEmailed   Boolean   @default(false)
  receiptPrintedAt DateTime?
  receiptEmailedAt DateTime?
  receiptNumber    String?

  // Notes
  discountReason String?
  notes          String?

  // Sync Metadata - HIGH PRIORITY
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?
  pendingSync  Boolean   @default(false)
  syncPriority Int       @default(10)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  lines         SaleOrderLine[]
  payments      Payment[]
  discounts     Discount[]
  returnOrders  ReturnOrder[]
  parkedOrders  ParkedOrder[]
  serialNumbers SerialNumber[]
  exchangesFrom ExchangeOrder[] @relation("ExchangeOriginal")
  exchangesTo   ExchangeOrder[] @relation("ExchangeNew")

  @@index([orderNumber])
  @@index([locationId])
  @@index([terminalId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("sale_orders")
}

model SaleOrderLine {
  id        String         @id @default(uuid())
  orderId   String
  order     SaleOrder      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  quantity       Int
  unitPrice      Float
  discountAmount Float @default(0)
  taxAmount      Float @default(0)
  lineTotal      Float

  notes String?

  // Sync Metadata
  syncVersion Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  serialNumbers SerialNumber[]

  @@index([orderId])
  @@index([variantId])
  @@map("sale_order_lines")
}

model Payment {
  id      String    @id @default(uuid())
  orderId String
  order   SaleOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  method   PaymentMethod
  amount   Float
  currency String        @default("USD")

  reference String?
  cardLast4 String?
  cardBrand String?
  authCode  String?

  status PaymentStatus @default(COMPLETED)

  // Sync Metadata - HIGH PRIORITY
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?
  syncPriority Int       @default(10)

  processedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orderId])
  @@index([method])
  @@index([status])
  @@map("payments")
}

model Discount {
  id      String    @id @default(uuid())
  orderId String
  order   SaleOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  type    DiscountType
  name    String
  code    String?
  amount  Float
  percent Float?

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([code])
  @@map("discounts")
}

enum OrderType {
  SALE
  RETURN
  EXCHANGE
  QUOTE
  LAYAWAY
}

enum OrderStatus {
  OPEN
  COMPLETED
  VOIDED
  PARKED
  CANCELLED
  REFUNDED
}

enum OrderSource {
  POS
  ONLINE
  MOBILE
  PHONE
  MARKETPLACE
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  GIFT_CARD
  STORE_CREDIT
  DIGITAL_WALLET
  CHECK
  CRYPTO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  BUY_X_GET_Y
  COUPON
  PROMOTIONAL
  LOYALTY
}

// ============================================
// RETURNS & EXCHANGES
// ============================================

model ReturnOrder {
  id              String    @id @default(uuid())
  returnNumber    String    @unique
  originalOrderId String
  originalOrder   SaleOrder @relation(fields: [originalOrderId], references: [id])
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  locationId      String
  location        Location  @relation(fields: [locationId], references: [id])

  reason ReturnReason?
  notes  String?

  subtotal  Float @default(0)
  taxAmount Float @default(0)
  total     Float @default(0)

  refundMethod RefundMethod?
  refundAmount Float         @default(0)

  status ReturnStatus @default(PENDING)

  processedBy String?
  processedAt DateTime?

  // Sync Metadata
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?
  terminalId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lines ReturnOrderLine[]

  @@index([returnNumber])
  @@index([originalOrderId])
  @@index([customerId])
  @@index([locationId])
  @@map("return_orders")
}

model ReturnOrderLine {
  id             String         @id @default(uuid())
  returnOrderId  String
  returnOrder    ReturnOrder    @relation(fields: [returnOrderId], references: [id], onDelete: Cascade)
  variantId      String
  variant        ProductVariant @relation(fields: [variantId], references: [id])
  originalLineId String? // Reference to original sale order line

  quantity  Int
  unitPrice Float
  lineTotal Float

  reason String?

  createdAt DateTime @default(now())

  @@index([returnOrderId])
  @@index([variantId])
  @@map("return_order_lines")
}

model ExchangeOrder {
  id              String    @id @default(uuid())
  exchangeNumber  String    @unique
  originalOrderId String
  originalOrder   SaleOrder @relation("ExchangeOriginal", fields: [originalOrderId], references: [id])
  newOrderId      String
  newOrder        SaleOrder @relation("ExchangeNew", fields: [newOrderId], references: [id])

  priceDifference   Float @default(0)
  additionalPayment Float @default(0)
  refundAmount      Float @default(0)

  processedBy String?
  processedAt DateTime @default(now())

  // Sync Metadata
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?

  @@index([originalOrderId])
  @@index([newOrderId])
  @@map("exchange_orders")
}

model ParkedOrder {
  id         String    @id @default(uuid())
  parkNumber String    @unique
  orderId    String
  order      SaleOrder @relation(fields: [orderId], references: [id])
  customerId String?
  parkedBy   String?
  parkedAt   DateTime  @default(now())
  expiryDate DateTime?
  notes      String?

  @@index([orderId])
  @@index([customerId])
  @@map("parked_orders")
}

enum ReturnReason {
  DEFECTIVE
  WRONG_ITEM
  SIZE_ISSUE
  COLOR_ISSUE
  QUALITY_ISSUE
  NO_LONGER_NEEDED
  BETTER_PRICE
  UNWANTED_GIFT
  DAMAGED
  INCORRECT_DESCRIPTION
}

enum RefundMethod {
  ORIGINAL_PAYMENT
  STORE_CREDIT
  CASH
  BANK_TRANSFER
  GIFT_CARD
}

enum ReturnStatus {
  PENDING
  APPROVED
  COMPLETED
  REJECTED
  PARTIALLY_APPROVED
}

// ============================================
// SHIFT MANAGEMENT
// ============================================

model Shift {
  id         String    @id @default(uuid())
  locationId String
  location   Location  @relation(fields: [locationId], references: [id])
  terminalId String?
  terminal   Terminal? @relation(fields: [terminalId], references: [id])
  userId     String
  user       User      @relation(fields: [userId], references: [id])

  shiftNumber String  @unique
  registerId  String?

  // Cash Management
  openingCash    Float  @default(0)
  closingCash    Float?
  expectedCash   Float?
  cashDifference Float?

  // Sales Summary
  totalSales        Float @default(0)
  totalRefunds      Float @default(0)
  totalTransactions Int   @default(0)

  // Timeline
  openedAt DateTime  @default(now())
  closedAt DateTime?

  status ShiftStatus @default(OPEN)
  notes  String?

  // Sync Metadata
  syncVersion  Int       @default(1)
  lastSyncedAt DateTime?

  // Relationships
  saleOrders SaleOrder[]

  @@index([shiftNumber])
  @@index([locationId])
  @@index([terminalId])
  @@index([status])
  @@map("shifts")
}

enum ShiftStatus {
  OPEN
  CLOSED
  SUSPENDED
}

// ============================================
// TAX CONFIGURATION
// ============================================

model TaxCategory {
  id      String @id @default(uuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  code        String  @unique
  name        String
  description String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]
  rates    TaxRate[]

  @@index([storeId])
  @@index([code])
  @@map("tax_categories")
}

model TaxRate {
  id            String      @id @default(uuid())
  taxCategoryId String
  taxCategory   TaxCategory @relation(fields: [taxCategoryId], references: [id], onDelete: Cascade)

  name String
  rate Float

  country String?
  state   String?
  city    String?

  isActive      Boolean   @default(true)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taxCategoryId])
  @@map("tax_rates")
}

// ============================================
// AUDIT & LOGS
// ============================================

model AuditLog {
  id      String @id @default(uuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  entityType String
  entityId   String
  action     AuditAction

  userId     String?
  username   String?
  terminalId String?
  terminal   Terminal? @relation(fields: [terminalId], references: [id])

  changes   Json?
  ipAddress String?
  userAgent String?

  timestamp DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([storeId])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([terminalId])
  @@index([timestamp])
  @@map("audit_logs")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  SYNC
  BACKUP
  RESTORE
  EXPORT
  IMPORT
}

// ============================================
// SETTINGS & CONFIGURATION
// ============================================

model StoreSettings {
  id      String @id @default(uuid())
  storeId String @unique
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // POS Settings
  receiptHeader String?
  receiptFooter String?
  receiptLogo   String[]
  printReceipt  Boolean  @default(true)
  emailReceipt  Boolean  @default(false)

  // Inventory Settings
  lowStockAlert     Boolean @default(true)
  negativeInventory Boolean @default(false)
  lowStockThreshold Int     @default(5)

  // Tax Settings
  taxInclusive     Boolean @default(false)
  autoCalculateTax Boolean @default(true)

  // Customer Settings
  customerRequired Boolean @default(false)
  defaultCustomer  String?

  // Security Settings
  sessionTimeout Int     @default(30) // minutes
  passwordPolicy String? // JSON

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("store_settings")
}
